#!/usr/bin/env node

const [,, ...args] = process.argv;
const path = require('path');
const { generateFromAI } = require(path.join(__dirname, '../src/core/ai.js'));
const logger = require(path.join(__dirname, '../src/core/logger.js')).default;
const readline = require('readline');

async function main() {
  if (args.length === 0) {
    logger.system('Usage: reinvent <string>');
    process.exit(1);
  }
  while (true) {
    try {
      const { output } = await generateFromAI(args.join(' '));
      logger.ai(output);
      logger.system('Execute the commands? (y = execute, n = exit, r = regenerate): ');
      const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
      });
      const answer = await new Promise(resolve => {
        rl.question('', resolve);
      });
      rl.close();
      if (answer.trim().toLowerCase() === 'y') {
        // Execute each command line by line in node
        const commands = output.split('\n').filter(Boolean);
        for (const cmd of commands) {
          try {
            logger.info(`\n> ${cmd}`);
            require('child_process').execSync(cmd, { stdio: 'inherit', shell: true });
          } catch (err) {
            logger.error('Error executing command: ' + (err.message || err));
          }
        }
        break;
      } else if (answer.trim().toLowerCase() === 'n') {
        logger.system('Exit.');
        break;
      } else if (answer.trim().toLowerCase() === 'r') {
        logger.system('Regenerating command(s)...');
        continue;
      } else {
        logger.warn('Invalid input. Please enter y, n, or r.');
      }
    } catch (err) {
      logger.error('Error: ' + (err.message || err));
      process.exit(1);
    }
  }
}

main();
